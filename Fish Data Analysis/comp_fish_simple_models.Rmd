---
title: "Fish Comparisons Simple Models"
output: html_notebook
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(car)
library(viridis)
library(boot)
library(mgcv)
library(forcats)
library(ggpubr)
```

Alright, so from all of this what do I know?

Speed Differences:
  Flow increases speed differences
  Ablation decreases speed differences
  Darkness increases speed differences
  Distance increases speed differences
  Angles around 90 degrees have a bigger difference in speed
  
Heading Differences:
  Fish are more aligned when they are around 90 degrees, slightly less in ablated fish
  
Synchronization:
  Darkness increases synchronization
  
NND:
  Darkness increases NND
  Flow decreases NND
  
Nearest Neighbor Bearing:
  In darkness fish are more in front or behind
  In flow fish are more in positioned alongside each other
  
  


Sets up the functions that will be used later 
```{r}
rad2deg <- function(rad) {(rad * 180) / (pi)}
deg2rad <- function(deg) {(deg * pi) / (180)}
round_any <- function(x, accuracy, f=round){f(x/ accuracy) * accuracy}
ang_mean <- function(x){rad2deg(atan(mean(sin(deg2rad(x)))/mean(cos(deg2rad(x)))))}

fold_angle_0_360_to_0_180 <- function(x){abs(abs(x-180)-180)}

fold_angle_neg_180_180_to_neg_90_90 <- function(x){ifelse(x > 90,90-abs(90-x),ifelse(x < -90, -90+abs(-90-x), x))}

min_n <- function(x,n){sort(x)[1:n]}
max_n <- function(x,n){sort(x,decreasing = TRUE)[1:n]}
```

Reads in the data and alters it as needed 
```{r}
comp_data <- read.csv("Fish_Comp_Values.csv")
comp_data <- na.omit(comp_data)

comp_data <- comp_data %>% mutate(Flow = ifelse(Flow == "0", "Flow 0", "Flow 2")) %>%
                           mutate(Ablation = ifelse(Ablation == "N", "No Ablation", "Ablated")) %>%
                           mutate(Darkness = ifelse(Darkness == "N", "Light", "Dark")) %>%
                           filter(Distance <= 4) %>%
                           filter(abs(Speed_Diff) <= 6) %>% 
                           mutate(Speed_Diff = abs(Speed_Diff)) %>%
                           mutate(fold_heading_diff = abs(fold_angle_neg_180_180_to_neg_90_90(Heading_Diff))) %>%
                           mutate(Is_Aligned = ifelse(Heading_Diff < 30, 1, 0)) %>%
                           mutate(Is_Reversed = ifelse(Heading_Diff > 150, 1, 0)) %>%
                           separate(Fish, c("Fish1", "Fish2"),sep="x") %>%
                           mutate(Flow = factor(Flow), Ablation = factor(Ablation), Darkness = factor(Darkness)) %>%
                           mutate(Flow = fct_relevel(Flow, c("Flow 0","Flow 2"))) %>%
                           mutate(Ablation = fct_relevel(Ablation, c("No Ablation","Ablated"))) %>%
                           mutate(Darkness = fct_relevel(Darkness, c("Light","Dark"))) %>%
                           mutate(rad_Angle = Angle) %>%
                           mutate(sin_Angle = sin(rad_Angle), cos_Angle = cos(rad_Angle)) %>%
                           mutate(Flow_Ablation_Darkness = factor(paste(Flow,Ablation,Darkness,sep=", ")))
                           
                           #mutate(Angle = fold_angle_0_360_to_0_180(Angle))

sum_comp_data <- comp_data %>% mutate(X_Distance = round_any(X_Distance,0.25), 
                                      Y_Distance = round_any(abs(Y_Distance),0.25)) %>%
                               group_by(Flow,Ablation,Darkness,X_Distance,Y_Distance) %>%
                               summarise(Speed_Diff = mean(Speed_Diff),
                                         Heading_Diff = ang_mean(Heading_Diff),
                                         Sync = mean(Sync),
                                         Fold_Heading_Diff = mean(fold_heading_diff),
                                         Is_Aligned = mean(Is_Aligned),
                                         Is_Reversed = mean(Is_Reversed))

comp_data_switch_fish <- comp_data %>% mutate(Fish3 = Fish1) %>%
                                       mutate(Fish1 = Fish2) %>%
                                       mutate(Fish2 = Fish3) %>%
                                       select(-c(Fish3))

comp_data_NND <- bind_rows(comp_data, comp_data_switch_fish) %>% group_by(Year,Month,Day,Trial,Fish1,Tailbeat.Num) %>%
                                                                 filter(Distance == min(Distance)) %>%
                                                                 ungroup()

comp_data_near_3 <- bind_rows(comp_data, comp_data_switch_fish) %>% group_by(Year,Month,Day,Trial,Fish1,Tailbeat.Num) %>%
                                                                 slice_min(Distance, n = 3) %>%
                                                                 ungroup() %>%
                                                                 distinct(Distance, .keep_all= TRUE)
```

#Basic Stats

```{r}
speed_anova <- aov(Speed_Diff ~ Flow + Ablation + Darkness + Flow:Ablation + Flow:Darkness, data = comp_data_near_3)

Anova(speed_anova)

heading_anova <- aov(fold_heading_diff ~ Flow + Ablation + Darkness + Flow:Ablation + Flow:Darkness, data = comp_data_near_3)

Anova(heading_anova)

sync_anova <- aov(Sync ~ Flow + Ablation + Darkness + Flow:Ablation + Flow:Darkness, data = comp_data_near_3)

Anova(sync_anova)

dist_anova <- aov(Distance ~ Flow + Ablation + Darkness + Flow:Ablation + Flow:Darkness, data = comp_data_NND)

Anova(dist_anova)

angle_anova <- aov(Angle ~ Flow + Ablation + Darkness + Flow:Ablation + Flow:Darkness, data = comp_data_NND)

Anova(dist_anova)
```

```{r}
ggplot(comp_data_near_3, aes(x = cos(deg2rad(Angle))))+
  geom_histogram()+
  facet_wrap(~ Flow + Ablation + Darkness)

ggplot(comp_data_near_3, aes(x = sin(deg2rad(Angle))))+
  geom_histogram()+
  facet_wrap(~ Flow + Ablation + Darkness)
```



```{r}
ggplot(comp_data_near_3, aes(x = Flow, y = Speed_Diff, fill = interaction(Ablation,Darkness,sep=", ")))+
  geom_boxplot(outlier.shape = NA) +
  guides(fill = guide_legend(title = "Condition")) +
  scale_fill_manual(values=c("#EEEEEE", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Available Senses on Speed Difference") +
  xlab("") +
  ylab("Speed Difference (BL/s)") +
  ylim(-0.1,2.5) +
  theme_light()

ggplot(comp_data_near_3, aes(x = Flow, y = fold_heading_diff, fill = interaction(Ablation,Darkness,sep=", ")))+
  geom_boxplot(outlier.shape = NA) +
  guides(fill = guide_legend(title = "Condition")) +
  scale_fill_manual(values=c("#EEEEEE", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Available Senses on Heading Difference") +
  xlab("") +
  ylab("Heading Difference (Degrees)") +
  theme_light()

ggplot(comp_data_near_3, aes(x = Flow, y = Sync, fill = interaction(Ablation,Darkness,sep=", ")))+
  geom_boxplot(outlier.shape = NA) +
  guides(fill = guide_legend(title = "Condition")) +
  scale_fill_manual(values=c("#EEEEEE", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Available Senses on Tailbeat Synchonization") +
  xlab("") +
  ylab("Syncronization") +
  theme_light()

ggplot(comp_data_near_3, aes(x = Flow, y = Distance, fill = interaction(Ablation,Darkness,sep=", ")))+
  geom_boxplot(outlier.shape = NA) +
  guides(fill = guide_legend(title = "Condition")) +
  scale_fill_manual(values=c("#EEEEEE", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Available Senses on Nearest Neighbor Distance (NND)") +
  xlab("") +
  ylab("NND (BL)") +
  theme_light()

ggplot(comp_data_near_3, aes(x = Flow, y = Angle, fill = interaction(Ablation,Darkness,sep=", ")))+
  geom_boxplot(outlier.shape = NA) +
  guides(fill = guide_legend(title = "Condition")) +
  scale_fill_manual(values=c("#EEEEEE", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Available Senses on Nearest Neighbor Bearing") +
  xlab("") +
  ylab("Nearest Neighbor Bearing (Degrees)") +
  scale_y_continuous(breaks = c(30,60,90,120,150)) +
  theme_light()

```

Trying GAMs

```{r}
speed_gam <- gam(Speed_Diff ~ s(Distance,Angle,by=Flow_Ablation_Darkness),
                              data = comp_data_near_3)

summary(speed_gam)

heading_gam <- gam(fold_heading_diff ~ s(Distance,Angle,by=Flow_Ablation_Darkness),
                              data = comp_data_near_3)

summary(heading_gam)

sync_gam <- gam(Sync ~ s(Distance,Angle,by=Flow_Ablation_Darkness),
                              data = comp_data_near_3)

summary(sync_gam)
```


Now we make some predictions for this.
```{r}
d <- seq(from = 0, to = 3, by = 0.1)
a <- seq(from = 0, to = 180, by = 10)

flows <- c("Flow 0", "Flow 2")
ablation <- c("No Ablation", "Ablated")
dark <- c("Light","Dark")

predict_df <- expand.grid(Distance = d, Angle = a, Flow = flows, Ablation = ablation, Darkness = dark)

predict_df <- predict_df %>% mutate(Flow_Ablation_Darkness = factor(paste(Flow,Ablation,Darkness,sep=", "))) %>% 
                            filter(!(Ablation == "Ablated" & Darkness == 'Dark'))

predict_df <- predict_df %>% mutate(pred_speed_diff = predict.gam(speed_gam,predict_df),
                                    pred_heading_diff = predict.gam(heading_gam,predict_df),
                                    pred_sync = predict.gam(sync_gam,predict_df))

predict_df <- predict_df %>% group_by(Distance,Flow,Ablation,Darkness) %>%
                             mutate(mean_Speed_Distance = mean(pred_speed_diff), sd_Speed_Distance = sd(pred_speed_diff),
                                    mean_Heading_Distance = mean(pred_heading_diff), sd_Heading_Distance = sd(pred_heading_diff),
                                    mean_Sync_Distance = mean(pred_sync), sd_Sync_Distance = sd(pred_sync)) %>%
                             ungroup() %>%
                             group_by(Angle,Flow,Ablation,Darkness) %>%
                             mutate(mean_Speed_Angle = mean(pred_speed_diff), sd_Speed_Angle = sd(pred_speed_diff),
                                    mean_Heading_Angle = mean(pred_heading_diff), sd_Heading_Angle = sd(pred_heading_diff),
                                    mean_Sync_Angle = mean(pred_sync), sd_Sync_Angle = sd(pred_sync)) %>%
                             ungroup()
```

And now we graph those?

```{r}
ggplot(predict_df, aes(x = Distance, y = mean_Speed_Distance, color = interaction(Ablation,Darkness,sep=", "),
                       fill = interaction(Ablation,Darkness,sep=" "))) +
  geom_line() +
  #geom_point(data=predict_df, aes(x = Distance, y = pred_speed_diff, alpha = 0.15)) +
  geom_ribbon(aes(ymin = mean_Speed_Distance-sd_Speed_Distance, ymax = mean_Speed_Distance+sd_Speed_Distance),
              linetype = 0,
              alpha = 0.1) +
  facet_wrap(~ Flow) +
  guides(fill = "none", color = guide_legend(title = "Condition")) +
  scale_color_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  scale_fill_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Distance and Senses on Speed Difference") +
  xlab("Distance (BL)") +
  ylab("Speed Difference (BL/s)") +
  ylim(0,1.5) +
  theme_light()

ggplot(predict_df, aes(x = Distance, y = mean_Heading_Distance, color = interaction(Ablation,Darkness,sep=", "),
                       fill = interaction(Ablation,Darkness,sep=", "))) +
  geom_line() +
  #geom_point(data=predict_df, aes(x = Distance, y = pred_heading_diff, alpha = 0.15)) +
  geom_ribbon(aes(ymin = mean_Heading_Distance-sd_Heading_Distance, ymax = mean_Heading_Distance+sd_Heading_Distance),
              linetype = 0,
              alpha = 0.1) +
  facet_wrap(~ Flow) +
  guides(fill = "none", color = guide_legend(title = "Condition")) +
  scale_color_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  scale_fill_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Distance and Senses on Heading Difference") +
  xlab("Distance (BL)") +
  ylab("Heading Difference (Degrees)") +
  ylim(0,50) +
  theme_light()

ggplot(predict_df, aes(x = Distance, y = mean_Sync_Distance, color = interaction(Ablation,Darkness,sep=", "),
                       fill = interaction(Ablation,Darkness,sep=", "))) +
  geom_line() +
  #geom_point(data=predict_df, aes(x = Distance, y = pred_sync, alpha = 0.15)) +
  geom_ribbon(aes(ymin = mean_Sync_Distance-sd_Sync_Distance, ymax = mean_Sync_Distance+sd_Sync_Distance),
              linetype = 0,
              alpha = 0.1) +
  facet_wrap(~ Flow) +
  guides(fill = "none", color = guide_legend(title = "Condition")) +
  scale_color_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  scale_fill_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Distance and Senses on Synchonization") +
  xlab("Distance (BL)") +
  ylab("Synchonization") +
  ylim(0,1)+
  theme_light()
```
```{r}
ggplot(predict_df, aes(x = Angle, y = mean_Speed_Angle, color = interaction(Ablation,Darkness,sep=", "),
                       fill = interaction(Ablation,Darkness,sep=", "))) +
  geom_line() +
  #geom_point(data=predict_df, aes(x = Angle, y = pred_speed_diff, alpha = 0.15)) +
  geom_ribbon(aes(ymin = mean_Speed_Angle-sd_Speed_Angle, ymax = mean_Speed_Angle+sd_Speed_Angle),
              linetype = 0,
              alpha = 0.1) +
  facet_wrap(~ Flow) +
  guides(fill = "none", color = guide_legend(title = "Condition")) +
  scale_color_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  scale_fill_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Bearing and Senses on Speed Difference") +
  xlab("Bearing (Degrees)") +
  ylab("Speed Difference (BL/s)") +
  ylim(0,1.5) +
  theme_light()

ggplot(predict_df, aes(x = Angle, y = mean_Heading_Angle, color = interaction(Ablation,Darkness,sep=", "),
                       fill = interaction(Ablation,Darkness,sep=", "))) +
  geom_line() +
  #geom_point(data=predict_df, aes(x = Angle, y = pred_heading_diff, alpha = 0.15)) +
  geom_ribbon(aes(ymin = mean_Heading_Angle-sd_Heading_Angle, ymax = mean_Heading_Angle+sd_Heading_Angle),
              linetype = 0,
              alpha = 0.1) +
  facet_wrap(~ Flow) +
  guides(fill = "none", color = guide_legend(title = "Condition")) +
  scale_color_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  scale_fill_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Bearing and Senses on Heading Difference") +
  xlab("Angle (Degrees)") +
  ylab("Heading Difference (Degrees)") +
  ylim(0,50) +
  theme_light()

ggplot(predict_df, aes(x = Angle, y = mean_Sync_Angle, color = interaction(Ablation,Darkness,sep=", "),
                       fill = interaction(Ablation,Darkness,sep=", "))) +
  geom_line() +
 #geom_point(data=predict_df, aes(x = Angle, y = pred_sync, alpha = 0.15)) +
  geom_ribbon(aes(ymin = mean_Sync_Angle-sd_Sync_Angle, ymax = mean_Sync_Angle+sd_Sync_Angle),
              linetype = 0,
              alpha = 0.1) +
  facet_wrap(~ Flow) +
  guides(fill = "none", color = guide_legend(title = "Condition")) +
  scale_color_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  scale_fill_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Bearing and Senses on Synchonization") +
  xlab("Bearing (Degrees)") +
  ylab("Synchonization") +
  ylim(0,1)+
  theme_light()
```
Density vs Things



```{r}
dist_bin_size <- 1
angle_bin_size <- 30

comp_data_freqs <- comp_data_near_3 %>% mutate(Dist_bin = round_any(Distance, dist_bin_size), 
                                               Angle_bin = round_any(Angle, angle_bin_size)) %>%
                                        group_by(Flow,Darkness,Ablation, Dist_bin, Angle_bin,Flow_Ablation_Darkness) %>%
                                        mutate(Count = n()) %>%
                                        ungroup() %>%
                                        group_by(Flow,Darkness,Ablation,Flow_Ablation_Darkness) %>%
                                        mutate(Freq = Count/n()) %>%
                                        ungroup() %>%
                                        group_by(Flow,Darkness,Ablation,Dist_bin,Angle_bin,Flow_Ablation_Darkness) %>%
                                        summarise(Speed_Diff = mean(Speed_Diff),
                                                  Fold_Heading_Diff = ang_mean(fold_heading_diff),
                                                  Sync = mean(Sync),
                                                  Freq = mean(Freq))

```

```{r}
freq_speed_glm <- glm(Speed_Diff ~ Freq*(Flow+Darkness+Ablation+Flow:Ablation+Flow:Darkness), data = comp_data_freqs)

summary(freq_speed_glm)

freq_heading_glm <- glm(Fold_Heading_Diff ~ Freq*(Flow+Darkness+Ablation+Flow:Ablation+Flow:Darkness), data = comp_data_freqs)

summary(freq_heading_glm)

freq_sync_glm <- glm(Sync ~ Freq*(Flow+Darkness+Ablation+Flow:Ablation+Flow:Darkness), data = comp_data_freqs)

summary(freq_sync_glm)

freq_speed_gam <- gam(Speed_Diff ~ s(Freq,by=Flow_Ablation_Darkness),
                              data = comp_data_freqs)

summary(freq_speed_gam)

freq_heading_gam <- gam(Fold_Heading_Diff ~ s(Freq,by=Flow_Ablation_Darkness),
                              data = comp_data_freqs)

summary(freq_heading_gam)

freq_sync_gam <- gam(Sync ~ s(Freq,by=Flow_Ablation_Darkness),
                              data = comp_data_freqs)

summary(freq_sync_gam)
```

Now we make some predictions for this.
```{r}
f <- seq(from = 0.005, to = 0.07, by = 0.001)

flows <- c("Flow 0", "Flow 2")
ablation <- c("No Ablation", "Ablated")
dark <- c("Light","Dark")

freq_predict_df <- expand.grid(Freq = f, Flow = flows, Ablation = ablation, Darkness = dark)

freq_predict_df <- freq_predict_df %>% mutate(Flow_Ablation_Darkness = factor(paste(Flow,Ablation,Darkness,sep=", "))) %>% 
                            filter(!(Ablation == "Ablated" & Darkness == 'Dark'))

freq_predict_df <- freq_predict_df %>% mutate(pred_speed_diff = predict.gam(freq_speed_gam,freq_predict_df),
                                    pred_heading_diff = predict.gam(freq_heading_gam,freq_predict_df),
                                    pred_sync = predict.gam(freq_sync_gam,freq_predict_df))

```


```{r}
ggplot(comp_data_freqs, aes(x = Freq, y = Speed_Diff, color = interaction(Ablation,Darkness,sep=", "),
                       fill = interaction(Ablation,Darkness,sep=", "))) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE) +
  facet_wrap(~ Flow) +
  guides(fill = "none", color = guide_legend(title = "Condition")) +
  scale_color_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  scale_fill_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Preference and Senses on Speed Difference") +
  xlab("Frequency of Observations") +
  ylab("Speed Difference (BL/s)") +
  theme_light()

ggplot(comp_data_freqs, aes(x = Freq, y = Fold_Heading_Diff, color = interaction(Ablation,Darkness,sep=", "),
                       fill = interaction(Ablation,Darkness,sep=", "))) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE) +
  facet_wrap(~ Flow) +
  guides(fill = "none", color = guide_legend(title = "Condition")) +
  scale_color_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  scale_fill_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Preference and Senses on Heading Difference") +
  xlab("Frequency of Observations") +
  ylab("Heading Difference (Degrees)") +
  theme_light()

ggplot(comp_data_freqs, aes(x = Freq, y = Sync, color = interaction(Ablation,Darkness,sep=", "),
                       fill = interaction(Ablation,Darkness,sep=", "))) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", formula = "y ~ x", se = FALSE) +
  facet_wrap(~ Flow) +
  guides(fill = "none", color = guide_legend(title = "Condition")) +
  scale_color_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  scale_fill_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Preference and Senses on Synchonization") +
  xlab("Frequency of Observations") +
  ylab("Synchonization") +
  theme_light()
```

```{r}
ggplot(freq_predict_df, aes(x = Freq, y = pred_speed_diff, color = interaction(Ablation,Darkness,sep=", "),
                       fill = interaction(Ablation,Darkness,sep=", "))) +
  geom_line() +
  facet_wrap(~ Flow) +
  guides(fill = "none", color = guide_legend(title = "Condition")) +
  scale_color_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  scale_fill_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Frequency of Observations on Speed Difference") +
  xlab("Frequency (%)") +
  ylab("Speed Difference (BL/s)") +
  theme_light()

ggplot(freq_predict_df, aes(x = Freq, y = pred_heading_diff, color = interaction(Ablation,Darkness,sep=", "),
                       fill = interaction(Ablation,Darkness,sep=", "))) +
  geom_line() +
  facet_wrap(~ Flow) +
  guides(fill = "none", color = guide_legend(title = "Condition")) +
  scale_color_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  scale_fill_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Frequency of Observations on Heading Difference") +
  xlab("Frequency (%)") +
  ylab("Heading Difference (Degrees)") +
  theme_light()

ggplot(freq_predict_df, aes(x = Freq, y = pred_sync, color = interaction(Ablation,Darkness,sep=", "),
                       fill = interaction(Ablation,Darkness,sep=", "))) +
  geom_line() +
  facet_wrap(~ Flow) +
  guides(fill = "none", color = guide_legend(title = "Condition")) +
  scale_color_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  scale_fill_manual(values=c("#000000", "#4CB944", "#00A7E1")) +
  ggtitle("Effect of Frequency of Observations on Synchonization") +
  xlab("Frequency (%)") +
  ylab("Synchonization") +
  theme_light()
```


